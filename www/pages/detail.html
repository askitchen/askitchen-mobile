<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">{{data.nama}}</div>
        <div class="right">
          <a href="/cart/" data-view=".view-main" class="link icon-only panel-close ac-more1">
            <i class="icon f7-icons ios-only">shopping_cart<span class="badge color-red"></span></i>
            <i class="icon material-icons md-only">shopping_cart<span class="badge color-red"></span></i>
          </a>
        </div>
      </div>
    </div>
    <div class="page-content">
        
      <div class="block header">
        <div data-pagination='{"el": ".swiper-pagination"}' class="swiper-container swiper-init swiper-detail">
          <div class="swiper-pagination detail"></div>
          <div class="swiper-wrapper"> <!-- image https://askitchen.com/upload/gambar/ -->
            <div class="swiper-slide"><span class="img-helper"></span><img class="lazy product" src="https://askitchen.com/upload/gambar/{{data.gambar}}" /></div>
            <div class="swiper-slide"><span class="img-helper"></span><img class="lazy product" src="https://askitchen.com/upload/gambar/{{#if data.gambar2}}{{data.gambar2}}{{else}}{{data.gambar}}{{/if}}" /></div>
            <div class="swiper-slide"><span class="img-helper"></span><img class="lazy product" src="https://askitchen.com/upload/gambar/{{#if data.gambar3}}{{data.gambar3}}{{else}}{{data.gambar}}{{/if}}" /></div>
          </div>
        </div>
      </div>
      
      <div class="card item-detail">
        <input type="hidden" class="item-code"    value="{{data.kdbar}}" />
        <input type="hidden" class="item-name"    value="{{data.nama}}" />
        <input type="hidden" class="item-price"   value="{{data.hjual}}" />
        <input type="hidden" class="item-picture" value="{{data.gambar}}" />
        <input type="hidden" class="last-value"   value="{{data.stok}}" />
        <!-- <input type="hidden" class="item-qty"     value="1"> -->
        
        <input type="hidden" id="maxqty" value="{{data.stok}}">
        <!-- <input type="hidden" id="minqty" value=""> -->

        <div class="card-footer detail">
          <div class="product-name">{{data.nama}}</div>
          {{#if data.stok}}
          <div class="stock-avail">Stock Available</div>
          {{/if}}
        </div>
        <div class="card-footer detail">
          <div class="product-price">Rp{{data.hjualf}}</div>
          <div class="product-price">
            {{#if data.stok}}
            <a href="#" class="button-add"><img src="img/cart.png" class="cart-img" /><span class="cart-label">Add To Cart</span></a>
            {{else}}
            <a href="#" class="button-coming"><span class="cart-label">Coming soon!</span></a>
            {{/if}}
          </div>
        </div>
        {{#if data.pnj}}
        <div class="product-size2">{{data.pnj}} x {{data.lbr}}{{#if data.tgi}} x {{data.tgi}}{{/if}}</div>
        {{/if}}
        <div class="product-code2">{{data.kdbar}}</div>
        <!-- <span id="rater" class="rating golden" data-default-rating="3"></span> -->
        <!-- <div class="starbox">
          <i class="f7-icons">star_fill</i>
          <i class="f7-icons">star_fill</i>
          <i class="f7-icons">star_fill</i>
          <i class="f7-icons">star</i>
          <i class="f7-icons">star</i>
        </div> -->
        {{#if data.stok}}
        <div class="card-footer detail">
          <div class="stepper stepper-fill stepper-init" data-wraps="false" data-autorepeat="true" data-autorepeat-dynamic="true" data-decimal-point="2" data-manual-input-mode="true">
            <div class="stepper-button-minus"></div>
            <div class="stepper-input-wrap">
              <input class="item-qty" type="text" value="{{#js_if 'this.data.minimum > 0'}}{{data.minimum}}{{else}}1{{/js_if}}" min="{{#js_if 'this.data.minimum > 0'}}{{data.minimum}}{{else}}1{{/js_if}}" max="{{data.stok}}" step="1">
            </div>
            <div class="stepper-button-plus"></div>
          </div>
        </div>
        {{/if}}
      </div>

      <div class="block">
        <div class="block-title detail">Description</div>
        <p class="product-desc">{{data.deskripsi}}</p>
      </div>
      
      <div class="block">
        <div class="block-title detail">Reviews</div>
        <div class="list media-list">
          <ul>
          {{#each data.reviews}}
            <li>
              <div class="item-content">
                <div class="item-media"><img class="img-review" src="img/user.png"></div>
                <div class="item-inner">
                  <div class="item-title-row">
                    <div class="item-title rev-name">{{name}}</div>
                  </div>
                  <div class="item-text">{{comment}}</div>
                </div>
              </div>
            </li>
          {{/each}}
          </ul>
        </div>
      </div>
    
      <div class="block">
        <div class="block-title detail">Related Products</div>
        <div data-space-between="10" data-slides-per-view="3" class="swiper-container swiper-init swiper-related">
          <!-- <div class="swiper-pagination"></div> -->
          <div class="swiper-wrapper">
            
            {{#each data.related}}
            <div class="swiper-slide detail">
              <a href="/detail/{{kdurl}}" class="item-link">
              <div>
                <img class="responsive-product lazy" src="https://askitchen.com/upload/gambar/{{gambar}}" />
                <!-- image https://askitchen.com/upload/gambar/ -->
              </div>
              <div class="product-name-rel">{{nama}}</div>
              <div class="product-price-rel">Rp{{hjual}}</div>
              {{#if pnj}}
              <div class="product-size-rel">{{pnj}} x {{lbr}}{{#if tgi}} x {{tgi}}{{/if}}</div>
              {{/if}}
              <div class="product-code-rel">{{kdbar}}</div>
              <img class="button-buy" src="img/beli.png" /></a>
            </div>
            {{/each}}

          </div>
        </div>
      </div>
      <!-- <div class="content-block"><a href="#" class="button button-raised button-fill larger btn-buy">Buy it now</a></div>
      <div class="content-block"><a href="#" class="button button-raised larger btn-cart">Add to cart</a></div>
      <div class="content-block"><a href="#" class="button button-raised larger btn-wish">Add to wish list</a></div> -->
    </div>
  </div>
</template>
<script>
  return {
    // Page Events
    on: {
      
      pageBeforeIn: function (event, page) {
        
        if (app.data.bLogedIn) {

          app.request.get("https://askitchen.com/api/v1/cart/total_items", function(res) {
                    
            var data = JSON.parse(res);
            
            if (data.status)
            {
              app.data.total_items = data.totqty;
            }
            else
            {
              $$('.badge').css("display", "none");
              app.data.total_items = 0;
            }
          });
        }

        if (app.data.total_items > 0) {
          $$('.badge').text(app.data.total_items);
          $$('.badge').css("display", "block");
        } else {
          $$('.badge').css("display", "none");
        }
      },
      
      pageInit: function(e, page) {

        // var starRating = new SimpleStarRating($$('#rater'));

        $$('.page-content').on('scroll', function (e) {
          // var scrollTop = e.srcElement.scrollTop;
          var scrollTop = $$('.card.item-detail').offset().top;
          var card = $$('.card.item-detail');
          
          // console.log(scrollTop)
          if (scrollTop >= 56) {
            card.removeClass("sticky")
          } else {
            card.addClass("sticky");
          }
        })

        $$('.button-add').on('click', function (e) {

          var page  = $$('.page-current');
          // var card  = $$('.item-detail');
          var kode  = page.find('.item-code').val();
          var qty   = page.find('.item-qty').val();
          var hjual = page.find('.item-price').val();

          var maxVal = parseInt($$('#maxqty').val());

          
          // cek login
          if (!app.data.bLogedIn) {
            
            app.data.lastURL = app.views.main.router.url;

            app.router.navigate('/login/', {
              reloadCurrent: true,
              ignoreCache: true,
            });
            return;
          }
          

          var bFound = false;

          for (var i =0; i < items.length; i++)
          if (items[i].kdbar === kode) {
            
            bFound = true;

            if (items[i].qty >= maxVal) {
              // console.log('item.qty >= maxVal')
              return;
            }
            
            // var x = parseInt(items[i].qty) + parseInt(qty);
            
            if (parseInt(items[i].qty) + parseInt(qty) > maxVal) {
              // console.log('maxVal: '+ maxVal)
              // console.log('item.qty + qty > maxVal')
              return;
            } else {
              items[i].qty += parseInt(qty);
            }
          }

          if (!bFound) {
            app.methods.addItem(kode, qty);
          }

          
          var formData = [];

          formData.kode  = kode;
          formData.qty   = qty;
          formData.hjual = hjual;
          // formData.Authorization = app.data.token;
          // app.methods.addItem(kode);

          app.request.post("https://askitchen.com/api/v1/cart", formData, function(res) {
              
            var data = JSON.parse(res);

            if (data.status)
            {
              app.data.total_items = data.totqty;
              $$('.badge').text(data.totqty);
              $$('.badge').css("display", "block");
            }
          });
        });
      }
    }
  }
</script>
