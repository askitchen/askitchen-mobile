<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">{{data.nama}}</div>
        <div class="right">
          <a href="/cart/" data-view=".view-main" class="link icon-only panel-close ac-more1">
            <i class="icon f7-icons ios-only">shopping_cart{{#js_if "app.data.total_items > 0"}}<span class="badge color-red"></span>{{/js_if}}</i>
            <i class="icon material-icons md-only">shopping_cart{{#js_if "app.data.total_items > 0"}}<span class="badge color-red"></span>{{/js_if}}</i>
          </a>
        </div>
      </div>
    </div>
    <div class="page-content">
        
      <div class="block header">
        <div data-pagination='{"el": ".swiper-pagination"}' class="swiper-container swiper-init swiper-detail">
          <div class="swiper-pagination detail"></div>
          <div class="swiper-wrapper">
            <div class="swiper-slide"><img class="lazy product" src="https://askitchen.com/upload/gambar/{{data.gambar}}" /></div>
            <div class="swiper-slide"><img class="lazy product" src="https://askitchen.com/upload/gambar/{{#if data.gambar2}}{{data.gambar2}}{{else}}{{data.gambar}}{{/if}}" /></div>
            <div class="swiper-slide"><img class="lazy product" src="https://askitchen.com/upload/gambar/{{#if data.gambar3}}{{data.gambar3}}{{else}}{{data.gambar}}{{/if}}" /></div>
          </div>
        </div>
      </div>
      
      <div class="card item-detail">
        <!-- <div style="background-image:url(https://askitchen.com/upload/gambar/{{data.gambar}}); width: 70%; height: 200px; margin: 0 auto;  background-size: cover;
        background-position: center; background-repeat: no-repeat;" valign="bottom" class="card-header color-white no-border">{{data.kdbar}}</div> -->
        <input type="hidden" class="item-code"    value="{{data.kdbar}}" />
        <input type="hidden" class="item-name"    value="{{data.nama}}" />
        <input type="hidden" class="item-price"   value="{{data.hjual}}" />
        <input type="hidden" class="item-picture" value="{{data.gambar}}" />
        <input type="hidden" class="last-value"   value="{{data.stok}}" />
        <input type="hidden" class="item-qty"     value="1">
        
        <input type="hidden" id="maxqty" value="{{data.stok}}">
        <input type="hidden" id="minqty" value="">

        <div class="card-footer detail">
          <div class="product-name">{{data.nama}}</div>
          <div class="stock-avail">Stock Available</div>
        </div>
        <div class="card-footer detail">
          <div class="product-price">Rp{{data.hjualf}}</div>
          <div class="product-price">
            <a href="#" class="button-add"><img src="img/cart.png" class="cart-img" /><span class="cart-label">Add To Cart</span></a>
          </div>
          <!-- <div class="delete"><a href="#" class="link icon-only"><i class="material-icons product-detail">delete</i></a></div> -->
        </div>
        {{#if data.pnj}}
        <div class="product-size2">{{data.pnj}} x {{data.lbr}}{{#if data.tgi}} x {{data.tgi}}{{/if}}</div>
        {{/if}}
        <div class="product-code2">{{data.kdbar}}</div>
        <!-- <div class="starbox">
          <i class="f7-icons">star_fill</i>
          <i class="f7-icons">star_fill</i>
          <i class="f7-icons">star_fill</i>
          <i class="f7-icons">star</i>
          <i class="f7-icons">star</i>
        </div> -->
      </div>

      <div class="block">
        <div class="block-title detail">Description</div>
        <p class="product-desc">{{data.deskripsi}}</p>
      </div>
      
      <div class="block">
        <div class="block-title detail">Reviews</div>
        <div class=""></div>
      </div>
    
      <div class="block">
        <div class="block-title detail">Related Products</div>
        <div data-space-between="10" data-slides-per-view="3" class="swiper-container swiper-init swiper-related">
          <!-- <div class="swiper-pagination"></div> -->
          <div class="swiper-wrapper">
            
            {{#each data.related}}
            <div class="swiper-slide detail">
              <a href="/detail/{{kdurl}}" class="item-link">
              <div>
                <img class="responsive-product lazy" src="https://askitchen.com/upload/gambar/{{gambar}}" />
                <!-- image -->
              </div></a>
              <div class="product-name-rel">{{nama}}</div>
              <div class="product-price-rel">Rp{{hjual}}</div>
              {{#if pnj}}
              <div class="product-size-rel">{{pnj}} x {{lbr}}{{#if tgi}} x {{tgi}}{{/if}}</div>
              {{/if}}
              <div class="product-code-rel">{{kdbar}}</div>
            </div>
            {{/each}}

          </div>
        </div>
      </div>
      <!-- <div class="content-block"><a href="#" class="button button-raised button-fill larger btn-buy">Buy it now</a></div>
      <div class="content-block"><a href="#" class="button button-raised larger btn-cart">Add to cart</a></div>
      <div class="content-block"><a href="#" class="button button-raised larger btn-wish">Add to wish list</a></div> -->
    </div>
  </div>
</template>
<script>
  return {
    // Page Events
    on: {
      
      // pageBeforeIn: function (event, page) {
        
      //   app.request.get("http://localhost/askitchenweb/api/v1/cart/total_items", function(res) {
          
      //     var data = JSON.parse(res);

      //     if (data.status)
      //     {
      //       app.data.total_items = data.totqty;
      //       // $$('.badge').text(app.data.total_items);
      //     }
      //   });
        
      //   // if (app.data.total_items > 0)
      //     $$('.badge').text(app.data.total_items);
      // },

      pageInit: function(e, page) {
        
        $$('.page-content').on('scroll', function (e) {
          // var scrollTop = e.srcElement.scrollTop;
          var scrollTop = $$('.card.item-detail').offset().top;
          var card = $$('.card.item-detail');
          
          // console.log(scrollTop)
          // if (scrollTop >= 56) {
          //   card.removeClass("sticky")
          // } else {
          //   card.addClass("sticky");
          // }
        })

        $$('.button-add').on('click', function (e) {
          
          if (!app.data.bLogedIn) {
            
            // app.data.lastURL = app.views.main.router.url;
            // console.log('Current url: ' + app.views.main.router.url)

            app.router.navigate('/login/', {
              reloadCurrent: true,
              ignoreCache: true,
            });
            return;
          }
          
          var card  = $$('.item-detail');
          var kode  = card.find('.item-code').val();
          var qty   = card.find('.item-qty').val();
          
          var formData = [];

          formData.kode = kode;
          formData.qty  = qty;
          // formData.Authorization = app.data.token;

          app.request.post("http://localhost/askitchenweb/api/v1/cart", formData, function(res) {
              
            var data = JSON.parse(res);
            
            // console.log('return data: '+res)

            if (data.status)
            {
              // console.log('request success!')

              if (app.data.total_items == 0) {
                // reload
                app.router.navigate(app.views.main.router.url, {
                  reloadCurrent: true,
                  ignoreCache: true,
                });
              
              } else {

                app.request.get("http://localhost/askitchenweb/api/v1/cart/total_items", function(res) {
                      
                  var data = JSON.parse(res);
                  
                  if (data.status)
                  {
                    app.data.total_items = data.totqty;
                    $$('.badge').text(data.totqty);
                  }
                });
              }
            }
            else
            {
              // show error message
            }
          });

        });
          
        $$('.btn-wish').on('click', function (e) {
          
          // app.dialog.alert('Add to wish list!');
          // if (!app.data.bLogedIn) {
          //   app.router.navigate('/login/', {
          //     reloadCurrent: true,
          //     ignoreCache: true,
          //   });
          // }

          var card  = $$('.item-detail');
          var kdbar = card.find('.item-code').val();
          var nama  = card.find('.item-name').val();
          var gambar= card.find('.item-picture').val();
          var harga = card.find('.item-price').val();

          // console.log (kdbar)
          // console.log (nama)
          // console.log (gambar)
          // console.log (harga)

          // app.dialog.alert(kdbar);
          // return;
          
          var db = app.data.db;
          if (db) {
            
            db.transaction(function(tx) {

              var now  = new Date();
              var date = now.getFullYear()+'/'+(now.getMonth()+1)+'/'+now.getDate();
              var time = date + " " + now.getHours() + ":" + now.getMinutes()
              
              // save to local db
              tx.executeSql('INSERT INTO wishlist (kdbar, nama, gambar, hjual, tglinput) VALUES (?,?,?,?,?);', [kdbar, nama, gambar, harga, time]);

              var formData = [];

              formData.kdbar = kdbar;
              formData.Authorization = app.data.token;

              app.request.post("http://localhost/askitchenweb/api/v1/wishlist", formData, function(res) {
                  
                var data = JSON.parse(res);
                if (this.status)
                {
                  app.dialog.alert('Sukses!')
                }
                else
                {
                  app.dialog.alert(this.message);
                }
              });

            }, function(error) {
              app.dialog.alert('INSERT error: ' + error.message);
            }, function() {
              // console.log('Sukses!.');
            });
          }
        });
      }
    }
  }
</script>
