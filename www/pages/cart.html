<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">Cart</div>
        <div class="right">
          <!--<a href="#" class="link icon-only panel-open" data-panel="right">-->
          <a href="#" data-view=".view-main" class="link icon-only panel-close ac-more2">
            <i class="icon f7-icons ios-only">settings</i>
            <i class="icon material-icons md-only">settings</i>
          </a>
        </div>
      </div>
      <div class="subnavbar cart">
        <!-- Searchbar with auto init -->
        <div class="total-label">
          Total
        </div>
        <div class="total-bar">
          <div class="gtotal">{{gtotal.toLocaleString('ID')}}</div>
        </div>
      </div>
    </div>
    <div class="page-content">

          {{#each detail}}
          <div class="card">
              <input type="hidden" class="item-code" value="{{this.kdbar}}" />
              <input type="hidden" class="last-value" value="{{this.qty}}" />
              <div class="card-header">
              <div class="product-name">{{this.nama}}</div>
            </div>
            <div class="card-footer">
              <!--<div class="left">
                  <div class="product-name">{{this.hjual.toLocaleString('ID')}}</div>
              </div>>-->
              <div class="left">
                <div class="stepper stepper-fill stepper-init" data-wraps="false" data-autorepeat="true" data-autorepeat-dynamic="true" data-decimal-point="2" data-manual-input-mode="true">
                  <div class="stepper-button-minus"></div>
                  <div class="stepper-input-wrap">
                    <input class="item-qty" type="text" value="{{this.qty}}" min="1" max="10000" step="1">
                  </div>
                  <div class="stepper-button-plus"></div>
                </div>
              </div>
              <div class="product-name">@Rp {{this.hjual.toLocaleString('ID')}}</div>
              <div class="product-name">Rp {{this.jumlah.toLocaleString('ID')}}</div>
            </div>
            <div class="card-footer">
              <!--<div class="left">-->
                <div class="icon-social"><a href="#" class="link icon-only"><i class="material-icons remove">delete</i></a></div>
                <div class="icon-social"><a href="/diskon-item/{{this.kdbar}}/" class="link icon-only">Diskon</a></div>
              <div class="right">
                {{#if disc}}<div class="product-name">Disc. {{this.disc}}%</div>{{/if}}
                {{#if discrp}}<div class="product-name">Disc Rp {{this.discrp.toLocaleString('ID')}}</div>{{/if}}
              </div>
            </div>
            <!--<div class="card-footer"> 
              <div class="left">
              </div>
              <div class="right">
                <div class="icon-social"><a href="#" class="link icon-only"><i class="material-icons remove">delete</i></a></div>
              </div>
            </div>-->
          </div>
          {{/each}}
    </div>
  </div>
</template>
<script>
  return {
    // Component Data
    data: function () {
      var self = this;
      // Must return an object
      return {
        gtotal: self.$app.data.gtotal,
        detail: details
      }
    },
    // Component Methods
    methods: {
      // addOne: function () {
      //   var self = this;
      //   self.$app.dialog.alert('Hello World');
      // },
    },
    // Page Events
    on: {
      pageInit: function(e, page) {
        
        app.methods.calcTotal();

        $$('.ac-more2').on('click', function () {
          // app.dialog.alert('tes')
          ac_more2.open();
        });

        $$('.page-content').on('change', 'div.stepper', function (e) {
          
          // console.log('stepper', e.srcElement.value);
          var value = e.srcElement.value;
          var card = $$(this).parents(".card");
          var kdbar = card.find('.item-code').val();

          for(var i=0; i < details.length; i++) {
            if(details[i].kdbar == kdbar)
            {
              card.find('.last-value').val(value);
              details[i].qty = value;
              // details[i].jumlah = value * details[i].hjual;
            }
          }
          
          // refresh total
          app.methods.calcTotal();

          // refresh total per item
          app.router.navigate('/cart/', {
            reloadCurrent: true,
            ignoreCache: true,
          });
        });
        
        $$('.page-content').on('click', 'div.stepper-button-minus', function (e) {
          var card = $$(this).parents(".card");
          var kdbar = card.find('.item-code').val();
          var lqty = parseInt(card.find('.last-value').val());
          var qty = parseInt(card.find('.item-qty').val());

          if (lqty > 1) {
            card.find('.last-value').val(qty);
          
            // refresh total
            app.methods.calcTotal();

            // refresh total per item
            app.router.navigate('/cart/', {
              reloadCurrent: true,
              ignoreCache: true,
            });
          } else {
            return;
          }
        });

        $$('.page-content').on('click', 'div.stepper-button-plus', function (e) {
          var card = $$(this).parents(".card");
          var kdbar = card.find('.item-code').val();
          var qty = parseInt(card.find('.item-qty').val());

          card.find('.last-value').val(qty);

          // refresh total
          app.methods.calcTotal();

          // refresh total per item
          app.router.navigate('/cart/', {
            reloadCurrent: true,
            ignoreCache: true,
          });
        });
        
        $$('.page-content').on('click', 'i.material-icons.remove', function (e) {
          
          var card = $$(this).parents(".card");
          var kdbar = card.find('.item-code').val();

          // hapus item
          for(var i=0; i < details.length; i++) {
            if(details[i].kdbar == kdbar)
            {
              details.splice(i,1);
            }
          }

          app.methods.calcTotal();
          
          if (details.length > 0) {
            app.router.navigate('/cart/', {
              reloadCurrent: true,
              ignoreCache: true,
            });
          } else {
            // app.router.navigate('/');
            mainView.router.back();
          }
        });
      },
    }
  }
</script>