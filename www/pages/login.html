<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">Login</div>
        <div class="right">
          <a href="/register/" data-view=".view-main" class="link icon-only">Daftar</a>
        </div>
      </div>
    </div>
    <div class="page-content">
        
      <form class="login-form form-ajax-submit">
        <div class="block">
          <input type="hidden" name="remember" value="0">
          <div class="list no-hairlines-md">
            <ul>
            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">E-Mail</div>
                  <div class="item-input-wrap">
                    <input type="text" id="email" name="identity" placeholder="E-Mail" />
                  </div>
                </div>
              </div>
            </li>
            <li>
              <div class="item-content item-input">
                <div class="item-inner">
                  <div class="item-title item-label">Password</div>
                  <div class="item-input-wrap">
                    <input type="password" id="password" name="password" placeholder="Password"/>
                  </div>
                </div>
              </div>
            </li>
            </ul>
          </div>
        </div>
        <div class="content-block"><a href="#" @click="doLogin" class="button button-raised button-fill larger login-button">LOGIN</a></div>
      </form>
    </div>
  </div>
</template>
<script>
  return {
    // Component Methods
    methods: {
      
      doLogin: function (e) {
        
        var email = $$('input [name="email"]').val();
        if (email == '') {
            app.dialog.alert('Masukkan alamat email anda.', 'Login');
            return;
        }
      
        var password = $$('input [name="password"]').val();
        if (password == '') {
            app.dialog.alert('Masukkan password anda.', 'Login');
            return;
        }
        
        app.preloader.show();
      
        var formData = app.form.convertToData('.login-form');
      
        // var regId = localStorage.getItem('RegId');
        // formData.gcmid = regId;
        
        app.request.post( app.data.endpoint + 'auth/login', formData, function (res) {
          
          app.preloader.hide();
          
          var data = JSON.parse(res);
      
          if (data.status) {
          
            localStorage.setItem('email', email);
            localStorage.setItem('password', password);
            
            app.data.bLogedIn = true;
            app.data.mbrid    = data.mbrid;
            app.data.email    = email;
            app.data.password = password;
            app.data.username = data.nama;
            app.data.token    = data.token;
            
            // kosongkan isian nomor pin
            $$('input [name="password"]').val('');
      
            if (app.data.lastURL) {
              
              app.router.navigate(app.data.lastURL, {
                reloadCurrent: true,
                ignoreCache: true,
              });
              app.data.lastURL = '';
            } //else {
            
            // tampilkan nama dan status
            $$('.member-name').text(data.nama);
            $$('.member-status').css('display', 'block');
            $$('.member-edit').css('display', 'block');
            
            // load profile picture
            var imageData = localStorage.getItem('profile');
            
            if (imageData) {
              $$('.responsive.profile').attr('src', "data:image/jpeg; base64," + imageData);
              $$('.responsive.profile2').attr('src', "data:image/jpeg; base64," + imageData);
            }
              
            //   var view = app.views.current;
            //   view.router.back(view.history[0], { force: true });
            // }
      
          } else {
            app.dialog.alert(data.message, 'Login');
          }
        });
      }
    }

  }
        
</script>
