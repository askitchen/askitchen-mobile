<template>
  <div data-page="tabs-swipeable" class="page toolbar-fixed">
    <div class="navbar">
      <div class="navbar-inner">
        <div class="left"><a href="#" class="back link icon-only"><i class="icon icon-back"></i></a></div>
        <div class="center">Checkout</div>
        <div class="right"><a href="#" class="link open-panel icon-only"><i class="icon icon-bars"></i></a></div>
      </div>
    </div>
    <div class="toolbar tabbar">
      <div class="toolbar-inner">
        <a href="#tab1" class="active tab-link checkout">Address</a>
        <a href="#tab2" class="tab-link checkout">Delivery</a>
        <a href="#tab3" class="tab-link checkout">Order Detail</a></div>
    </div>
    <div class="tabs-swipeable-wrap">
      <div class="tabs">
        <div id="tab1" class="page-content tab active">
          <div class="content-block">
            <div class="block">
              <div class="list no-hairlines-md">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">First Name</div>
                      <div class="item-input-wrap">
                        <input type="text" id="first_name" name="first_name" placeholder="First Name"/>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Last Name</div>
                      <div class="item-input-wrap">
                        <input type="text" id="last_name" name="last_name" placeholder="Last Name"/>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Company</div>
                      <div class="item-input-wrap">
                        <input type="text" id="company" name="company" placeholder="Company"/>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Address</div>
                      <div class="item-input-wrap">
                        <input type="text" id="address" name="address" placeholder="Address"/>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Province</div>
                      <div class="item-input-wrap">
                        <select id="province" name="province">
                          <option value="" selected>-</option>
                          <option value="1">BALI</option>
                          <option value="2">BANGKA BELITUNG</option>
                          <option value="3">BANTEN</option>
                          <option value="4">BENGKULU</option>
                          <option value="5">DI YOGYAKARTA</option>
                          <option value="6">DKI JAKARTA</option>
                          <option value="7">GORONTALO</option>
                          <option value="8">JAMBI</option>
                          <option value="9">JAWA BARAT</option>
                          <option value="10">JAWA TENGAH</option>
                          <option value="11">JAWA TIMUR</option>
                          <option value="12">KALIMANTAN BARAT</option>
                          <option value="13">KALIMANTAN SELATAN</option>
                          <option value="14">KALIMANTAN TENGAH</option>
                          <option value="15">KALIMANTAN TIMUR</option>
                          <option value="16">KALIMANTAN UTARA</option>
                          <option value="17">KEPULAUAN RIAU</option>
                          <option value="18">LAMPUNG</option>
                          <option value="19">MALUKU</option>
                          <option value="20">MALUKU UTARA</option>
                          <option value="21">NANGGROE ACEH DARUSSALAM (NAD)</option>
                          <option value="22">NUSA TENGGARA BARAT (NTB)</option>
                          <option value="23">NUSA TENGGARA TIMUR (NTT)</option>
                          <option value="24">PAPUA</option>
                          <option value="25">PAPUA BARAT</option>
                          <option value="26">RIAU</option>
                          <option value="27">SULAWESI BARAT</option>
                          <option value="28">SULAWESI SELATAN</option>
                          <option value="29">SULAWESI TENGAH</option>
                          <option value="30">SULAWESI TENGGARA</option>
                          <option value="31">SULAWESI UTARA</option>
                          <option value="32">SUMATERA BARAT</option>
                          <option value="33">SUMATERA SELATAN</option>
                          <option value="34">SUMATERA UTARA</option>
                        </select>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Regency</div>
                      <div class="item-input-wrap">
                        <select id="regency" name="regency">
                        </select>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">District</div>
                      <div class="item-input-wrap">
                        <select id="district" name="district">
                        </select>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Post Code</div>
                      <div class="item-input-wrap">
                        <input type="text" id="post_code" name="post_code" placeholder="Post code" autocomplete="off" onkeypress="return isNumber(event)"/>
                      </div>
                    </div>
                  </li>
                                
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Phone</div>
                      <div class="item-input-wrap">
                        <input type="text" id="phone" name="phone" placeholder="Phone" autocomplete="off" onkeypress="return isNumber(event)"/>
                      </div>
                    </div>
                  </li>
                  <script type="text/javascript">
                      
                    function isNumber(evt) {
                      evt = (evt) ? evt : window.event;
                      var charCode = (evt.which) ? evt.which : evt.keyCode;
                      if (charCode > 31 && (charCode < 48 || charCode > 57)) {
                        return false;
                      }
                      return true;
                    }
                  </script>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">E-Mail</div>
                      <div class="item-input-wrap">
                        <input type="text" id="email" name="email" placeholder="E-Mail" autocomplete="off"/>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Note</div>
                      <div class="item-input-wrap">
                        <input type="text" id="note" name="note" placeholder="Note" autocomplete="off"/>
                      </div>
                    </div>
                  </li>
                </ul>
              </div>
            </div>
          </div>
        </div>
        <div id="tab2" class="page-content tab">
          <div class="content-block">
            
            <div class="block">
              <div class="list no-hairlines-md">
                <ul>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Carrier</div>
                      <div class="item-input-wrap">
                        <select id="carrier" name="carrier">
                        </select>
                      </div>
                    </div>
                  </li>
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Package</div>
                      <div class="item-input-wrap">
                        <select id="package" name="package">
                        </select>
                      </div>
                    </div>
                  </li>
                  
                  <!-- payment type -->
                  <li class="item-content item-input">
                    <div class="item-inner">
                      <div class="item-title item-label">Payment</div>
                      <div class="item-input-wrap">
                        <select id="payment" name="payment">
                          <option value="" selected>-</option>
                          <option value="15">Credit Card (Visa &amp; Mastercard)</option>
                          <option value="31">Indomaret</option>
                          <option value="35">Alfamart</option>
                        </select>
                      </div>
                    </div>
                  </li>
                <ul>
              </div>
            </div>

          </div>
        </div>
        <div id="tab3" class="page-content tab">
          <!-- <div class="content-block">
            <div class="block"> -->
                <div class="card data-table">
                  <table>
                    <thead>
                      <tr>
                        <!-- <input type="hidden" name="kode" value="">
                        <input type="hidden" name="qty" value="">
                        <input type="hidden" name="harga" value=""> -->
                        <th class="label-cell">Product</th>
                        <th class="numeric-cell">Total</th>
                      </tr>
                    </thead>
                    <tbody>
                      {{#each data}}
                      <tr>
                        <td class="label-cell">{{nama}}</td>
                        <td class="numeric-cell">{{hargaf}}</td>
                      </tr>
                      {{/each}}
                    </tbody>
                  </table>
                  <div class="card-footer">
                    <div class="product-name">Subtotal</div>
                    <div class="product-price">Rp{{$root.total.toLocaleString('ID')}}</div>
                  </div>
                  <div class="card-footer">
                    <div class="product-name">Tax</div>
                    <div class="product-price"><b>Rp<span id="spantax">0</span></b></div>
                  </div>
                  <div class="card-footer">
                    <div class="product-name">Shipping</div>
                    <div class="product-price"><b>Rp<span id="spanship">0</span></b></div>
                  </div>
                  <div class="card-footer">
                    <div class="product-name">Processing</div>
                    <div class="product-price"><b>Rp<span id="spanproc">0</span></b></div>
                  </div>
                  <div class="card-footer">
                    <div class="product-name">Total</div>
                    <div class="product-price"><b>Rp<span id="spangt"></span></b></div>
                  </div>
                </div>
            <!-- </div>
          </div> -->
          <div class="content-block"><a href="#" class="button button-raised button-fill larger btn-pay">Pay</a></div>
        </div>
      </div>
    </div>
  </div>
</template>

                        
<input type="hidden" id="total"    name="total"    value="0">
<input type="hidden" id="shipcost" name="shipcost" value="0">
<input type="hidden" id="svcname"  name="svcname"  value="jne">
<input type="hidden" id="tax"      name="tax"      value="0">
<input type="hidden" id="add_fee"  name="add_fee"  value="0">
<input type="hidden" id="gtotal"   name="gtotal"   value="0">

<form action="" id="frmDoku" method="post" >

  <input name="BASKET" type="hidden" id="BASKET" value="" />
  <input name="MALLID" type="hidden" id="MALLID" value="5338" />
  <input name="SHAREDKEY" type="hidden" id="SHAREDKEY" value="XJNLey8o6u38" maxlength="12"/>
  <input name="CHAINMERCHANT" type="hidden" id="CHAINMERCHANT" value="NA" />
  <input name="CURRENCY" type="hidden" id="CURRENCY" value="360" maxlength="3" />
  <input name="PURCHASECURRENCY" type="hidden" id="PURCHASECURRENCY" value="360" maxlength="3" />
  <input name="AMOUNT" type="hidden" id="AMOUNT" value="0" />
  <input name="PURCHASEAMOUNT" type="hidden" id="PURCHASEAMOUNT" value="0" />
  <input name="TRANSIDMERCHANT" type="hidden" id="TRANSIDMERCHANT" />
  <input name="WORDS" type="hidden" id="WORDS" />
  <input name="REQUESTDATETIME" type="hidden" id="REQUESTDATETIME" maxlength="14" />
  <input name="SESSIONID" type="hidden" id="SESSIONID" />
  <input name="PAYMENTCHANNEL" type="hidden" id="PAYMENTCHANNEL" value="15" />
  <input name="EMAIL" type="hidden" id="EMAIL2" value="" />
  <input name="NAME" type="hidden" id="NAME" value="" maxlength="50" />

  <input name="ADDRESS" type="hidden" id="ADDRESS" value="" maxlength="50" />
  <input name="COUNTRY" type="hidden" id="COUNTRY" value="360" maxlength="50" />
  <input name="STATE" type="hidden" id="STATE" value="" maxlength="50" />
  <input name="PROVINCE" type="hidden" id="PROVINCE2" value="" maxlength="50" />
  <input name="CITY" type="hidden" id="CITY" value="" maxlength="50" />
  <input name="ZIPCODE" type="hidden" id="ZIPCODE" value="" maxlength="10" />

  <input name="SHIPPING_ADDRESS" type="hidden" id="SHIPPING_ADDRESS2" value="" maxlength="10" />
  <input name="SHIPPING_CITY" type="hidden" id="SHIPPING_CITY2" value="" maxlength="10" />
  <input name="SHIPPING_COUNTRY" type="hidden" id="SHIPPING_COUNTRY" value="ID" maxlength="10" />
  <input name="SHIPPING_ZIPCODE" type="hidden" id="SHIPPING_ZIPCODE2" value="" maxlength="10" />

  <input name="HOMEPHONE" type="hidden" id="HOMEPHONE" value="" maxlength="20" />
  <input name="MOBILEPHONE" type="hidden" id="MOBILEPHONE2" value="" maxlength="20" />
  <input name="WORKPHONE" type="hidden" id="WORKPHONE" value="" maxlength="20" />
  <input name="BIRTHDATE" type="hidden" id="BIRTHDATE" value="" maxlength="8" />
</form>

<script>
  return {
    methods: {
      getRequestDateTime: function(form) {
        var now = new Date();
        form.REQUESTDATETIME.value = dateFormat(now, "yyyymmddHHMMss");
      },
      randomString: function(len) {
        
        var chars = "0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz";
        var string_length = len;
        var randomstring = '';
        for (var i=0; i<string_length; i++) {
          var rnum = Math.floor(Math.random() * chars.length);
          randomstring += chars.substring(rnum,rnum+1);
        }

        return randomstring;
      
      },
      genInvoice: function(form) {
        form.TRANSIDMERCHANT.value = this.randomString(12);
      },
      genSessionID: function(form) {
        form.SESSIONID.value = this.randomString(20);
      },
      genBookingCode: function(form) {
        form.BOOKINGCODE.value = this.randomString(6);
      },
      getWords: function(form) {
        // document.MerchatPaymentPage
        var msg = form.AMOUNT.value + form.MALLID.value + form.SHAREDKEY.value + form.TRANSIDMERCHANT.value;
        form.WORDS.value = SHA1(msg);
      },
    },
    // Page Events
    on: {
      
      pageBeforeIn: function (event, page) {
        
          if (app.data.bLogedIn) {
            
            app.request.getJSON("http://localhost/askitchenweb/api/v1/member/" + app.data.mbrid, function(res) {
              
              $$('#first_name').val(res.first_name);
              $$('#last_name').val(res.last_name);
              $$('#company').val(res.company);
              $$('#address').val(res.address);
              
              $$('#province').val(res.province);

              app.request.json("http://localhost/askitchenweb/api/v1/checkout/regencies/"+res.province, function(json) {
            
                var data = json.data; //, firstid = data[0].id;
                // console.log('firstid: '+firstid)

                $$('#regency').html('');
                for (var i = 0; i < data.length; i++) {
                  $$('#regency').append('<option value="'+data[i].id+'">'+data[i].name+'</option>')
                }
                
                if (res.regency) {
                  $$('#regency').val(res.regency);

                  app.request.json("http://localhost/askitchenweb/api/v1/checkout/districts/"+res.regency, function(json) {
                    var data = json.data;

                    $$('#district').html('');
                    for (var i = 0; i < data.length; i++) {
                        $$('#district').append('<option value="'+data[i].subdistrict_id+'">'+data[i].subdistrict_name+'</option>')
                    }
                    $$('#district').val(res.district);
                  });

                  app.request.json("http://localhost/askitchenweb/api/v1/checkout/post_code/"+res.regency, function(json) {
                    var data = json.data;
                    $$('#post_code').val(data.postal_code);

                  });
                }
              });

              // console.log(res.regency)
              // console.log(res.district)

              $$('#post_code').val(res.post_code);
              $$('#phone').val(res.phone);
              $$('#email').val(res.email);
            });

          }

          app.request.get("http://localhost/askitchenweb/api/v1/cart/total_items", function(res) {
            
            var data = JSON.parse(res);
  
            if (data.status)
            {
              app.data.total_items = data.totqty;
              // $$('.badge').text(app.data.total_items);
            }
          });
          
          if (app.data.total_items > 0) {
            $$('.badge').text(app.data.total_items);
            $$('.badge').css("display", "block");
          } else {
            $$('.badge').css("display", "none");
          }
        },
        
      pageInit: function(e, page) {
        
        $$('#spangt').text(app.data.gtotal.toLocaleString());

        $$('.btn-pay').click(function(event) {
            
          event.preventDefault();
          // $$(this).attr("disabled", "disabled");
          
          if ($$('#first_name').val() == '')
          {
              app.dialog.alert('Please enter first name.');
              $$( "#first_name" ).focus();
              return;
          }
          else if ($$('#last_name').val() == '')
          {
              app.dialog.alert('Please enter last name.');
              $$( "#last_name" ).focus();
              return;
          }
          // else if ($$('#company').val() == '')
          // {
          //     app.dialog.alert('Please enter company.');
          //     $$( "#company" ).focus();
          //     return;
          // }
          else if ($$('#address').val() == '')
          {
              app.dialog.alert('Please enter address.');
              $$( "#address" ).focus();
              return;
          }
          else if ($$('#province').val() == '')
          {
              app.dialog.alert('Please enter province.');
              $$( "#province" ).focus();
              return;
          }
          else if ($$('#regency').val() == '')
          {
              app.dialog.alert('Please enter regency.');
              $$( "#regency" ).focus();
              return;
          }
          else if ($$('#district').val() == '')
          {
              app.dialog.alert('Please enter district.');
              $$( "#district" ).focus();
              return;
          }
          else if ($$('#phone').val() == '')
          {
              app.dialog.alert('Please enter phone number.');
              $$( "#phone" ).focus();
              return;
          }
          else if ($$('#email').val() == '')
          {
              app.dialog.alert('Please enter email address.');
              $$( "#email" ).focus();
              return;
          }

          var form = $$('#frmDoku');

          // fill data
          this.genInvoice(form);
          this.getWords(form);
          this.getRequestDateTime(form);
          this.genSessionID(form);

          var formData = [];
          
          formData.first_name = $$('#first_name').val();
          formData.last_name  = $$('#last_name').val();
          formData.company    = $$('#company').val();
          formData.address    = $$('#address').val();
          formData.province   = $$('#province').val();
          formData.regency    = $$('#regency').val();
          formData.district   = $$('#district').val();
          formData.phone      = $$('#phone').val();
          formData.email      = $$('#email').val();
          formData.note       = $$('#note').val();

          formData.transidmerchant = $$('#TRANSIDMERCHANT').val()
          formData.words      = $$('#WORDS').val()
  
          formData.total      = $$('#total').val();
          formData.shipcost   = $$('#shipcost').val();
          formData.svcname    = $$('#svcname').val();
          formData.tax        = $$('#tax').val();
          formData.add_fee    = $$('#add_fee').val();
          formData.gtotal     = $$('#gtotal').val();

          
          app.request.post("http://localhost/askitchenweb/api/v1/snap/savetrx", formData, function(data) {

            console.log('token = '+ data); // snap token
            
            var formDoku = app.form.convertToData('#frmDoku');
            app.request.post("https://staging.doku.com/Suite/Receive", formDoku, function(data) {

            });
          });
        });

        app.request.json("http://localhost/askitchenweb/api/v1/checkout/carrier", function(json) {
          
          var data = json.data;

          $$('#carrier').html('');
          for (var i = 0; i < data.length; i++) {
              $$('#carrier').append('<option value="'+data[i].code+'">'+data[i].name+'</option>')
          }
        });

        $$('#province').on('change', function(e){
          
          var provid = $$(this).val();

          app.request.json("http://localhost/askitchenweb/api/v1/checkout/regencies/"+provid, function(json) {
            
            var data = json.data, firstid = data[0].id;
            // console.log('firstid: '+firstid)

            $$('#regency').html('');
            for (var i = 0; i < data.length; i++) {
              $$('#regency').append('<option value="'+data[i].id+'">'+data[i].name+'</option>')
            }

            app.request.json("http://localhost/askitchenweb/api/v1/checkout/districts/"+firstid, function(json) {
              var data = json.data;

              $$('#district').html('');
              for (var i = 0; i < data.length; i++) {
                  $$('#district').append('<option value="'+data[i].subdistrict_id+'">'+data[i].subdistrict_name+'</option>')
              }
            });

            app.request.json("http://localhost/askitchenweb/api/v1/checkout/post_code/"+firstid, function(json) {
              var data = json.data;
              $$('#post_code').val(data.postal_code);

            });
          
            // var carrier = $$('#carrier').val();

            // get ship cost - default from JNE
            app.request.json("http://localhost/askitchenweb/api/v1/checkout/ongkir/jne/"+firstid, function(json) {
                
              var data = json.data,
                  cost = parseFloat(data[0].cost[0].value);
              
              // console.log('data: '+data)
              
              // hitung total ongkos kirim
              app.request.json("http://localhost/askitchenweb/api/v1/checkout/hitung_ongkir/"+cost, function(json) {
              
                var data  = json.data;

                app.data.shipcost = data.shipcost;
                $$('#spanship').text(app.data.shipcost.toLocaleString());
                // console.log('shipcost: '+data.shipcost)

                app.data.gtotal   = app.data.total + data.shipcost;
                $$('#spangt').text(app.data.gtotal.toLocaleString());
                // console.log('total: '+app.data.gtotal)
              });

              $$('#package').html('');
              for (var i = 0; i < data.length; i++) {
                  $$('#package').append('<option value="'+data[i].cost[0].value+'">'+data[i].service+'</option>')
              }
              // $$('#svcname').val( $$('#package').text()); // nama service/layanan
            });
          });
        });

        $$('#regency').on('change', function(e){
          
          // get district data
          app.request.json("http://localhost/askitchenweb/api/v1/checkout/districts/"+$$(this).val(), function(json) {
            
            var data = json.data;

            $$('#district').html('');
            for (var i = 0; i < data.length; i++) {
                $$('#district').append('<option value="'+data[i].subdistrict_id+'">'+data[i].subdistrict_name+'</option>')
            }
          });

          // get post code
          app.request.json("http://localhost/askitchenweb/api/v1/checkout/post_code/"+$$(this).val(), function(json) {
            var data = json.data;
            $$('#post_code').val(data.postal_code);
          });
          
          var carrier = $$('#carrier').val();

          // get ship cost
          app.request.json("http://localhost/askitchenweb/api/v1/checkout/ongkir/"+carrier+"/"+$$(this).val(), function(json) {
              
            var data  = json.data,
                cost  = parseFloat(data[0].cost[0].value);

            // console.log('cost: '+cost)
            
            // hitung total ongkos kirim
            app.request.json("http://localhost/askitchenweb/api/v1/checkout/hitung_ongkir/"+cost, function(json) {
            
              var data  = json.data;

              app.data.shipcost = data.shipcost;
              $$('#spanship').text(app.data.shipcost.toLocaleString());

              app.data.gtotal   = app.data.total + data.shipcost;
              $$('#spangt').text(app.data.gtotal.toLocaleString());
            });

            $$('#package').html('');
            for (var i = 0; i < data.length; i++) {
                $$('#package').append('<option value="'+data[i].cost[0].value+'">'+data[i].service+'</option>')
            }
            // $$('#svcname').val( $$('#package').text()); // nama service/layanan
          });
        });


        $$('#carrier').on('change', function(e){
          var city = $$('#regency').val();

          app.request.json("http://localhost/askitchenweb/api/v1/checkout/ongkir/"+$$(this).val()+"/"+city, function(json) {
            
            var data  = json.data,
                cost  = parseFloat(data[0].cost[0].value);

            // console.log('cost: '+cost)
            
            // hitung total ongkos kirim
            app.request.json("http://localhost/askitchenweb/api/v1/checkout/hitung_ongkir/"+cost, function(json) {
            
              var data  = json.data;

              app.data.shipcost = data.shipcost;
              $$('#spanship').text(app.data.shipcost.toLocaleString());

              app.data.gtotal   = app.data.total + data.shipcost;
              $$('#spangt').text(app.data.gtotal.toLocaleString());
            });

            $$('#package').html('');
            for (var i = 0; i < data.length; i++) {
                $$('#package').append('<option value="'+data[i].cost[0].value+'">'+data[i].service+'</option>')
            }
            // $$('#svcname').val( $$('#package').text()); // nama service/layanan

          });

        });

        $$('#package').on('change', function(e){
          
          var cost  = parseFloat( $$(this).val());
            
          // hitung total ongkos kirim
          app.request.json("http://localhost/askitchenweb/api/v1/checkout/hitung_ongkir/"+cost, function(json) {
            
            var data  = json.data;

            app.data.shipcost = data.shipcost;
            $$('#spanship').text(app.data.shipcost.toLocaleString());

            app.data.gtotal   = app.data.total + data.shipcost;
            $$('#spangt').text(app.data.gtotal.toLocaleString());
          });
        });

        $$('#payment').on('change', function(e){
          
          var pm_mtd  = $$(this).val();
            
          // hitung total ongkos kirim
          app.request.json("http://localhost/askitchenweb/api/v1/checkout/hitung_biaya/"+pm_mtd+"/"+total, function(json) {
            
            var data  = json.data;

            app.data.addcost = data.shipcost;
            $$('#spanship').text(app.data.shipcost.toLocaleString());

            app.data.gtotal   = app.data.total + data.shipcost;
            $$('#spangt').text(app.data.gtotal.toLocaleString());
          });
        });
      }
    }
  }
</script>