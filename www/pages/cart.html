<template>
  <div class="page">
    <div class="navbar">
      <div class="navbar-inner sliding">
        <div class="left">
          <a href="#" class="link back">
            <i class="icon icon-back"></i>
            <span class="ios-only">Back</span>
          </a>
        </div>
        <div class="title">Cart</div>
      </div>
    </div>
    
    <div class="page-content">
        
      {{#each data}}
      <div class="card item-cart">
          <img class="responsive-product lazy" src="https://askitchen.com/upload/gambar/{{gambar}}" />
          <input type="hidden" class="item-code" value="{{this.kdbar}}" />
          <input type="hidden" class="item-qty"  value="{{this.qty}}" />
          <!-- <input type="hidden" class="item-name"  value="{{this.nama}}" />
          <input type="hidden" class="item-price" value="{{this.hjual}}" /> -->
          
          <div class="card-footer">
            <div class="product-name">{{this.nama}}</div>
            <div class="delete"><a href="#" class="link icon-only btn-delete"><i class="material-icons remove-item">delete</i></a></div>
          </div>
          <div class="card-footer">
            <div></div>
            <div class="product-price">Rp{{this.hargaf}}</div>
          </div>
      </div>
      {{/each}}

      {{#js_if "app.data.total > 0"}}
      <div class="card">
        <div class="card-footer">
          <div class="product-name">Total:</div>
          <div class="product-price">Rp{{$root.total.toLocaleString('ID')}}</div>
        </div>
        <div class="card-footer">
          <a href="#" @click="doCheckout" class="button button-raised button-fill larger btn-checkout">Proceed to checkout</a>
        </div>
      </div>
      {{/js_if}}
    </div>
  </div>
</template>
<script>
  return {
    // Component Methods
    methods: {
      
      doCheckout: function (e) {
        
        if (app.data.total == 0) {
          app.dialog.alert('Keranjang belanja anda masih kosong.');
          return;
        }

        app.router.navigate('/checkout/', {
          reloadCurrent: true,
          ignoreCache: true,
        });

      }
    },
        
    // Page Events
    on: {
      
      pageInit: function(e, page) {
        
        $$('.btn-delete').on('click', function (e) {

          var card  = $$(this).parents('.item-cart');
          var kode  = card.find('.item-code').val();
          var qty   = card.find('.item-qty').val();
          // console.log('remove item '+ kode);

          var formData = [];

          formData.kode = kode;
          formData.qty  = qty;
          // formData.Authorization = app.data.token;

          app.request.post("http://localhost/askitchenweb/api/v1/cart/remove", formData, function(res) {
              
            var data = JSON.parse(res);
            app.data.total_items = data.totqty;

            card.remove();

            app.router.navigate('/cart/', {
              reloadCurrent: true,
              ignoreCache: true,
            });
          });
        });
      }
    }
  }
</script>
